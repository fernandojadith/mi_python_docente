{% extends "admin/base_site.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div style="padding: 30px;">

    <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 50px; color: #1a1a1a;">
        Panel de Control 游늵 
    </h1>

    

    <!-- ============================
          游늵 GR츼FICO 1: POR FORMACI칍N (Periodo actual)
          ============================ -->
    <h2 style="font-size: 40px; text-align: center; margin-bottom: 20px; color:#0052cc; font-weight:bold;">
        Aprobados por formaci칩n (Periodo actual)
    </h2>

    <p style="font-size: 18px; margin-bottom: 25px;">
        <strong>Periodo actual:</strong> {{ periodo }}
    </p>

    <p style="font-size:18px; font-weight:bold; margin-bottom:15px; color:#0052cc;">
        Total aprobados: {{ total_aprobados_formacion }}
    </p>

    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
        <tr>
        {% for f in formaciones %}
            <td style="padding:10px; border:1px solid #ddd; font-size:16px; font-weight:600; color:#333; text-align:center;">
                {{ f.formacion }}
                <div style="margin-top:6px; display:inline-block; background:#0052cc; color:white; font-weight:bold; padding:4px 10px; border-radius:6px;">
                    {{ f.aprobados }}
                </div>
            </td>
            {% if forloop.counter|divisibleby:4 %}</tr><tr>{% endif %}
        {% endfor %}
        </tr>
    </table>

    <!-- Datos (label: valor) que refleja la gr치fica 1 -->
    <div id="formacionesData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

    <div style="background:white; border-radius: 12px; padding: 25px; margin-bottom: 60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <canvas id="formacionesChart" width="600" height="200"></canvas>
    </div>

    <hr style="margin:50px 0; border:5px solid #ddd;">

    <!-- ============================
          游늵 GR츼FICO 2: HIST칍RICO POR FORMACI칍N
          ============================ -->
    <h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">Hist칩rico de aprobados por formaci칩n</h2>

    <form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
        <label for="a침o"><strong>A침o:</strong></label>
        <select name="a침o" id="a침o" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona a침o ---</option>
            {% for a침o in a침os_opciones %}
                <option value="{{ a침o }}" {% if a침o_filtro == a침o %}selected{% endif %}>{{ a침o }}</option>
            {% endfor %}
        </select>

        <label for="opcion"><strong>Filtro:</strong></label>
        <select name="opcion" id="opcion" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona opci칩n ---</option>
            {% for op in opciones_filtro %}
                <option value="{{ op.value }}" {% if opcion_filtro == op.value %}selected{% endif %}>{{ op.label }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
            Aplicar filtros
        </button>
    </form>

    <p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
        Total aprobados: {{ total_aprobados_formacion_hist }}
    </p>

    <!-- Datos (label: valor) que refleja la gr치fica 2 -->
    <div id="formacionesHistData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

    <div style="background:white; border-radius: 12px; padding: 25px; margin-bottom: 60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <canvas id="formacionesHistChart" width="600" height="200"></canvas>
    </div>

    <hr style="margin:50px 0; border:5px solid #ddd;">

    <!-- ============================
          游늵 GR츼FICO 3: POR 츼REA
          ============================ -->
    <h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">Programas Aprobados por 치rea</h2>

    <form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
        <label for="programa"><strong>Programa:</strong></label>
        <select name="programa" id="programa" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">Todos los programas</option>
            {% for prog in programas %}
                <option value="{{ prog.id_programa }}" {% if prog.id_programa|stringformat:"s" == request.GET.programa %}selected{% endif %}>
                    {{ prog.Programa }}
                </option>
            {% endfor %}
        </select>

        <label for="a침o_area"><strong>A침o:</strong></label>
        <select name="a침o_area" id="a침o_area" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona a침o ---</option>
            {% for a침o in a침os_opciones %}
                <option value="{{ a침o }}" {% if a침o_area == a침o %}selected{% endif %}>{{ a침o }}</option>
            {% endfor %}
        </select>

        <label for="momento_area"><strong>Momento:</strong></label>
        <select name="momento_area" id="momento_area" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona opci칩n ---</option>
            {% for op in opciones_filtro %}
                <option value="{{ op.value }}" {% if momento_area == op.value %}selected{% endif %}>{{ op.label }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
            Aplicar filtros
        </button>
    </form>

    <p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
        Total aprobados: {{ total_aprobados_area }}
    </p>

    <!-- Datos (label: valor) que refleja la gr치fica 3 -->
    <div id="areasData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

    <div style="background:white; border-radius: 12px; padding: 25px; margin-bottom:60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <canvas id="areasChart" width="600" height="200"></canvas>
    </div>

    <hr style="margin:50px 0; border:5px solid #ddd;">

    <!-- ============================
          游늵 GR츼FICO 4: POR FORMACI칍N (con filtro)
          ============================ -->
    <h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">Porgramas Aprobados por formaci칩n </h2>

    <form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
        <label for="programa_formacion"><strong>Programa:</strong></label>
        <select name="programa_formacion" id="programa_formacion" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">Todos los programas</option>
            {% for prog in programas %}
                <option value="{{ prog.id_programa }}" {% if prog.id_programa|stringformat:"s" == request.GET.programa_formacion %}selected{% endif %}>
                    {{ prog.Programa }}
                </option>
            {% endfor %}
        </select>

        <label for="a침o_formacion"><strong>A침o:</strong></label>
        <select name="a침o_formacion" id="a침o_formacion" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona a침o ---</option>
            {% for a침o in a침os_opciones %}
                <option value="{{ a침o }}" {% if a침o_formacion == a침o %}selected{% endif %}>{{ a침o }}</option>
            {% endfor %}
        </select>

        <label for="momento_formacion"><strong>Momento:</strong></label>
        <select name="momento_formacion" id="momento_formacion" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona opci칩n ---</option>
            {% for op in opciones_filtro %}
                <option value="{{ op.value }}" {% if momento_formacion == op.value %}selected{% endif %}>{{ op.label }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
            Aplicar filtros
        </button>
    </form>

    <p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
        Total aprobados: {{ total_aprobados_formacion_filtro }}
    </p>

    <!-- Datos (label: valor) que refleja la gr치fica 4 -->
    <div id="formacionesFiltroData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

    <div style="background:white; border-radius: 12px; padding: 25px; margin-bottom:60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <canvas id="formacionesFiltroChart" width="600" height="200"></canvas>
    </div>

    <hr style="margin:50px 0; border:5px solid #ddd;">

    <!-- ============================
          游늵 GR츼FICO 5: DOCENTES CON Y SIN FORMACI칍N POR FACULTAD (PASTEL DERECHA)
          ============================ -->
    <h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">Docentes con formaci칩n por facultad</h2>

    <form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
        <label for="facultad"><strong>Facultad:</strong></label>
        <select name="facultad" id="facultad" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona facultad ---</option>
            {% for fac in facultades %}
                <option value="{{ fac.id_facultad }}" {% if fac.id_facultad|stringformat:"s" == request.GET.facultad %}selected{% endif %}>{{ fac.facultad }}</option>
            {% endfor %}
        </select>

        <label for="a침o_facultad"><strong>A침o:</strong></label>
        <select name="a침o_facultad" id="a침o_facultad" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona a침o ---</option>
            {% for a침o in a침os_opciones %}
                <option value="{{ a침o }}" {% if a침o_facultad == a침o %}selected{% endif %}>{{ a침o }}</option>
            {% endfor %}
        </select>

        <label for="momento_facultad"><strong>Momento:</strong></label>
        <select name="momento_facultad" id="momento_facultad" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            <option value="">--- Selecciona opci칩n ---</option>
            {% for op in opciones_filtro %}
                <option value="{{ op.value }}" {% if momento_facultad == op.value %}selected{% endif %}>{{ op.label }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
            Aplicar filtros
        </button>
    </form>

    <p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
        Total docentes: {{ total_docentes_facultad }} | Con formaci칩n: {{ docentes_con_formacion }}
    </p>

    <!-- Datos (label: valor) que refleja la gr치fica 5 (pie) -->
    <div id="facultadData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

    <div style="display:flex; justify-content:center; align-items:center;">
            <div style="width: 600px; height: 600px; background:white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <canvas id="facultadChart"></canvas>
</div>

        </div>


    <hr style="margin:50px 0; border:5px solid #ddd;">
    

    <!-- ============================
      游늵 GR츼FICO 6 : 츼REAS POR FACULTAD
      ============================ -->
<h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">
    Aprobados por 치rea dentro de una Facultad
</h2>

<form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
    <label for="facultad_area"><strong>Facultad:</strong></label>
    <select name="facultad_area" id="facultad_area" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona facultad ---</option>
        {% for fac in facultades %}
            <option value="{{ fac.id_facultad }}" {% if fac.id_facultad|stringformat:"s" == facultad_area %}selected{% endif %}>{{ fac.facultad }}</option>
        {% endfor %}
    </select>

    <label for="a침o_area_fac"><strong>A침o:</strong></label>
    <select name="a침o_area_fac" id="a침o_area_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona a침o ---</option>
        {% for a침o in a침os_opciones %}
            <option value="{{ a침o }}" {% if a침o_area_fac == a침o %}selected{% endif %}>{{ a침o }}</option>
        {% endfor %}
    </select>

    <label for="momento_area_fac"><strong>Momento:</strong></label>
    <select name="momento_area_fac" id="momento_area_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona opci칩n ---</option>
        {% for op in opciones_filtro %}
            <option value="{{ op.value }}" {% if momento_area_fac == op.value %}selected{% endif %}>{{ op.label }}</option>
        {% endfor %}
    </select>

    <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
        Aplicar filtros
    </button>
</form>

<p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
    Total aprobados: {{ total_aprobados_area_fac }}
</p>

<!-- Datos (label: valor) -->
<div id="areasFacData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

<div style="background:white; border-radius: 12px; padding: 25px; margin-bottom:60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <canvas id="areasFacChart" width="600" height="200"></canvas>
</div>


<hr style="margin:50px 0; border:5px solid #ddd;">

<!-- ============================
  游늵 GR츼FICO 7 : PROGRAMAS POR FACULTAD
  ============================ -->
<h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">
    Aprobados por programa dentro de una Facultad
</h2>

<form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
    <label for="facultad_programa"><strong>Facultad:</strong></label>
    <select name="facultad_programa" id="facultad_programa" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona facultad ---</option>
        {% for fac in facultades %}
            <option value="{{ fac.id_facultad }}" {% if fac.id_facultad|stringformat:"s" == facultad_programa %}selected{% endif %}>
                {{ fac.facultad }}
            </option>
        {% endfor %}
    </select>

    <label for="a침o_programa_fac"><strong>A침o:</strong></label>
    <select name="a침o_programa_fac" id="a침o_programa_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona a침o ---</option>
        {% for a침o in a침os_opciones %}
            <option value="{{ a침o }}" {% if a침o_programa_fac == a침o %}selected{% endif %}>{{ a침o }}</option>
        {% endfor %}
    </select>

    <label for="momento_programa_fac"><strong>Momento:</strong></label>
    <select name="momento_programa_fac" id="momento_programa_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona opci칩n ---</option>
        {% for op in opciones_filtro %}
            <option value="{{ op.value }}" {% if momento_programa_fac == op.value %}selected{% endif %}>
                {{ op.label }}
            </option>
        {% endfor %}
    </select>

    <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
        Aplicar filtros
    </button>
</form>

<p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
    Total aprobados: {{ total_aprobados_programa_fac }}
</p>

<!-- Datos (label: valor) -->
<div id="programasFacData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

<div style="background:white; border-radius: 12px; padding: 25px; margin-bottom:60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <canvas id="programasFacChart" width="600" height="200"></canvas>
</div>

<hr style="margin:50px 0; border:5px solid #ddd;">

<!-- ============================
  游늵 GR츼FICO 8 : FORMACIONES POR FACULTAD
  ============================ -->
<h2 style="font-size: 40px; text-align: center; margin-bottom: 50px; color:#0052cc; font-weight:bold;">
    Aprobados por formaci칩n dentro de una Facultad
</h2>

<form method="get" style="margin-bottom:20px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
    <label for="facultad_formacion"><strong>Facultad:</strong></label>
    <select name="facultad_formacion" id="facultad_formacion" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona facultad ---</option>
        {% for fac in facultades %}
            <option value="{{ fac.id_facultad }}" {% if fac.id_facultad|stringformat:"s" == facultad_formacion %}selected{% endif %}>
                {{ fac.facultad }}
            </option>
        {% endfor %}
    </select>

    <label for="a침o_formacion_fac"><strong>A침o:</strong></label>
    <select name="a침o_formacion_fac" id="a침o_formacion_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona a침o ---</option>
        {% for a침o in a침os_opciones %}
            <option value="{{ a침o }}" {% if a침o_formacion_fac == a침o %}selected{% endif %}>{{ a침o }}</option>
        {% endfor %}
    </select>

    <label for="momento_formacion_fac"><strong>Momento:</strong></label>
    <select name="momento_formacion_fac" id="momento_formacion_fac" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
        <option value="">--- Selecciona opci칩n ---</option>
        {% for op in opciones_filtro %}
            <option value="{{ op.value }}" {% if momento_formacion_fac == op.value %}selected{% endif %}>
                {{ op.label }}
            </option>
        {% endfor %}
    </select>

    <button type="submit" style="padding:6px 15px; background:#0052cc; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
        Aplicar filtros
    </button>
</form>

<p style="font-size:18px; font-weight:bold; margin-bottom:12px; color:#0052cc;">
    Total aprobados: {{ total_aprobados_formacion_fac }}
</p>

<!-- Datos (label: valor) -->
<div id="formacionesFacData" style="margin-bottom:12px; font-size:15px; color:#333;"></div>

<div style="background:white; border-radius: 12px; padding: 25px; margin-bottom:60px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
    <canvas id="formacionesFacChart" width="600" height="200"></canvas>
</div>


<hr style="margin:50px 0; border:5px solid #ddd;">








</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
    function wrapLabel(label, maxLength = 20) {
        if (!label) return label;
        if (label.length > maxLength) {
            return label.match(new RegExp('.{1,' + maxLength + '}', 'g'));
        }
        return label;
    }

    // Funci칩n para sanitizar/parsing del JSON que env칤a Django (mantengo tu enfoque original)
    function getSafeJson(djangoVar) {
        try {
            return JSON.parse(djangoVar.replace(/'/g, '"'));
        } catch (e) {
            // si ya viene como objeto, devolverlo
            return djangoVar;
        }
    }

    // Renderiza arriba del canvas un peque침o listado "label: valor"
    function renderChartData(containerId, labelsDjangoVar, valuesDjangoVar) {
        var labels = getSafeJson(labelsDjangoVar) || [];
        var values = getSafeJson(valuesDjangoVar) || [];
        var container = document.getElementById(containerId);
        if (!container) return;
        if (!labels.length) {
            container.innerHTML = '<p style="color:#888; margin:0;">Sin datos</p>';
            return;
        }
        var html = '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
        for (var i = 0; i < labels.length; i++) {
            var lab = labels[i] === null ? 'Sin nombre' : labels[i];
            var val = (values[i] !== undefined && values[i] !== null) ? values[i] : 0;
            html += '<div style="background:#f6f8fb; padding:6px 10px; border-radius:8px; font-weight:600; color:#333;">' +
                        lab + ': ' +
                        '<span style="background:#0052cc; color:white; padding:2px 8px; border-radius:6px; margin-left:8px; font-weight:700;">' + val + '</span>' +
                    '</div>';
        }
        html += '</div>';
        container.innerHTML = html;
    }

    // === Render datos arriba de cada gr치fica ===
    renderChartData('formacionesData', '{{ chart_labels_formacion|safe }}', '{{ chart_values_formacion|safe }}');
    renderChartData('formacionesHistData', '{{ chart_labels_formacion_hist|safe }}', '{{ chart_values_formacion_hist|safe }}');
    renderChartData('areasData', '{{ chart_labels_area|safe }}', '{{ chart_values_area|safe }}');
    renderChartData('formacionesFiltroData', '{{ chart_labels_formacion_filtro|safe }}', '{{ chart_values_formacion_filtro|safe }}');
    renderChartData('facultadData', '{{ chart_labels_facultad|safe }}', '{{ chart_values_facultad|safe }}');

    // === Gr치ficos (mantengo tu l칩gica original para Chart.js) ===

    // Gr치fico 1
    const chartData1 = getSafeJson('{{ chart_labels_formacion|safe }}');
    const chartValues1 = getSafeJson('{{ chart_values_formacion|safe }}');
    new Chart(document.getElementById('formacionesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData1.map(label => wrapLabel(label)),
            datasets: [{
                label: 'Aprobados',
                data: chartValues1,
                backgroundColor: '#0052cc'
            }]
        },
        options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
    });
    // Funci칩n para actualizar por AJAX (sin refrescar la p치gina)
async function updateChart1() {
    const response = await fetch("/chart1/data/");
    const data = await response.json();

    chart1.data.labels = data.labels;
    chart1.data.datasets[0].data = data.values;
    chart1.update();

    document.getElementById("formacionesData").innerHTML =
        "<b>Total aprobados:</b> " + data.total;
}

    // Gr치fico 2
    const chartData2 = getSafeJson('{{ chart_labels_formacion_hist|safe }}');
    const chartValues2 = getSafeJson('{{ chart_values_formacion_hist|safe }}');
    new Chart(document.getElementById('formacionesHistChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData2.map(label => wrapLabel(label)),
            datasets: [{
                label: 'Aprobados',
                data: chartValues2,
                backgroundColor: '#0052cc'
            }]
        },
        options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
    });

    // Gr치fico 3
    const chartData3 = getSafeJson('{{ chart_labels_area|safe }}');
    const chartValues3 = getSafeJson('{{ chart_values_area|safe }}');
    new Chart(document.getElementById('areasChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData3.map(label => wrapLabel(label)),
            datasets: [{
                label: 'Aprobados',
                data: chartValues3,
                backgroundColor: '#0052cc'
            }]
        },
        options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
    });

    // Gr치fico 4
    const chartData4 = getSafeJson('{{ chart_labels_formacion_filtro|safe }}');
    const chartValues4 = getSafeJson('{{ chart_values_formacion_filtro|safe }}');
    new Chart(document.getElementById('formacionesFiltroChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartData4.map(label => wrapLabel(label)),
            datasets: [{
                label: 'Aprobados',
                data: chartValues4,
                backgroundColor: '#0052cc'
            }]
        },
        options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
    });

    // Gr치fico 5 (pastel)
    const chartData5 = getSafeJson('{{ chart_labels_facultad|safe }}');
    const chartValues5 = getSafeJson('{{ chart_values_facultad|safe }}');

new Chart(document.getElementById('facultadChart').getContext('2d'), {
    type: 'pie',
    data: {
        labels: chartData5,
        datasets: [{
            label: 'Docentes',
            data: chartValues5,
            backgroundColor: ['#0052cc','#28a745']
        }]
    },
    options: { 
        responsive: true, 
        plugins: { 
            legend: { position:'bottom' },
            datalabels: {
                color: '#fff',
                font: { weight: 'bold', size: 14 },
                formatter: function(value, ctx) {
                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    let percentage = (value * 100 / sum).toFixed(1) + "%";
                    return percentage;
                }
            }
        } 
    },
    plugins: [ChartDataLabels]   // 游녣 ACTIVAR EL PLUGIN
});

// Render datos de la nueva gr치fica
renderChartData('areasFacData', '{{ chart_labels_area_fac|safe }}', '{{ chart_values_area_fac|safe }}');

// Nueva gr치fica (치reas por facultad)
const chartDataAF = getSafeJson('{{ chart_labels_area_fac|safe }}');
const chartValuesAF = getSafeJson('{{ chart_values_area_fac|safe }}');
new Chart(document.getElementById('areasFacChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: chartDataAF.map(label => wrapLabel(label)),
        datasets: [{
            label: 'Aprobados',
            data: chartValuesAF,
            backgroundColor: '#28a745'
        }]
    },
    options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
});
// Render datos de la gr치fica 7
renderChartData('programasFacData', '{{ chart_labels_programa_fac|safe }}', '{{ chart_values_programa_fac|safe }}');

// Nueva gr치fica (programas por facultad)
const chartDataPF = getSafeJson('{{ chart_labels_programa_fac|safe }}');
const chartValuesPF = getSafeJson('{{ chart_values_programa_fac|safe }}');
new Chart(document.getElementById('programasFacChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: chartDataPF.map(label => wrapLabel(label)),
        datasets: [{
            label: 'Aprobados',
            data: chartValuesPF,
            backgroundColor: '#ff9800'
        }]
    },
    options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
});
// Render datos de la gr치fica 8
renderChartData('formacionesFacData', '{{ chart_labels_formacion_fac|safe }}', '{{ chart_values_formacion_fac|safe }}');

// Nueva gr치fica (formaciones por facultad)
const chartDataFF = getSafeJson('{{ chart_labels_formacion_fac|safe }}');
const chartValuesFF = getSafeJson('{{ chart_values_formacion_fac|safe }}');
new Chart(document.getElementById('formacionesFacChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: chartDataFF.map(label => wrapLabel(label)),
        datasets: [{
            label: 'Aprobados',
            data: chartValuesFF,
            backgroundColor: '#9c27b0'
        }]
    },
    options: { 
        responsive: true, 
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    callback: function(value) {
                        return Number.isInteger(value) ? value : null;
                    }
                }
            }
        }
    }
});



</script>
{% endblock %}
